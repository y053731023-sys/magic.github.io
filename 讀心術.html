<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Card</title>
    <style>
        :root {
            --card-sprite: none; 
            --card-back-img: none;
            --bg-size-x: 1300%;
            --bg-size-y: 400%;
            --bg-off-x: 0px;
            --bg-off-y: 0px;
        }

        body {
            background-color: #111; 
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- 隱藏按鈕 (右上角) --- */
        #help-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            opacity: 0.05; 
            background: white;
            border-radius: 50%;
            cursor: pointer;
            z-index: 999;
        }
        #help-btn:active { opacity: 0.3; }

        /* --- 區間透視層 --- */
        #zone-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 800;
            pointer-events: none;
        }
        #zone-overlay.visible { display: flex; }

        .zone-col {
            flex: 1;
            height: 100%;
            border-right: 1px dashed rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 20, 40, 0.7);
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }
        .zone-col:last-child { border-right: none; }
        .zone-title { font-size: 10px; color: #888; margin-bottom: 5px; }
        .zone-card { font-size: 20px; font-weight: bold; }
        .red-text { color: #ff6b6b; }

        /* --- 設定選單 Modal --- */
        #help-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            padding: 30px 20px;
            box-sizing: border-box;
            text-align: left;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }
        
        #help-modal h3 { color: #a29bfe; margin: 15px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 8px; width: 100%; font-size: 18px; }
        #help-modal p { font-size: 13px; color: #bbb; line-height: 1.6; margin-bottom: 10px; }
        
        .mode-switch-group { display: flex; gap: 10px; width: 100%; margin-bottom: 20px; }
        .mode-option { flex: 1; padding: 15px; background: #222; border: 2px solid #333; border-radius: 8px; color: #777; text-align: center; cursor: pointer; transition: all 0.2s; }
        .mode-option.active { background: #2d2d2d; border-color: #6c5ce7; color: #fff; box-shadow: 0 0 10px rgba(108, 92, 231, 0.3); }
        .mode-title { font-weight: bold; font-size: 16px; margin-bottom: 5px; display: block; }
        .mode-desc { font-size: 11px; display: block; }

        .settings-box { width: 100%; background: #1a1a1a; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .card-setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 14px; }
        .card-setting-row select { background: #333; color: white; border: 1px solid #555; padding: 5px; border-radius: 4px; }
        
        .settings-btns { display: flex; gap: 10px; margin-top: 15px; width: 100%; }
        .setting-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-save { background: #6c5ce7; color: white; }
        .btn-reset { background: #444; color: #ccc; }
        .close-help { padding: 12px; background: transparent; color: #888; border: 1px solid #444; border-radius: 50px; margin-top: 20px; width: 100%; }

        .upload-section { margin-bottom: 20px; text-align: center; border: 1px dashed #444; padding: 15px; border-radius: 8px; }
        .upload-label { display: block; margin-bottom: 10px; color: #aaa; font-size: 13px; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .btn-upload { border: 1px solid #666; color: white; background-color: #333; padding: 8px 20px; border-radius: 8px; font-size: 14px; cursor: pointer; }
        .file-input-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }

        /* --- 遊戲區域 --- */
        .game-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            position: relative;
        }

        .card-container {
            position: relative;
            width: 100%; 
            height: 100%; 
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
        }

        /* 撲克牌樣式 */
        .card {
            width: 18vw; 
            height: 27vw;
            max-width: 90px; 
            max-height: 135px;
            
            background-color: white;
            background-image: var(--card-sprite); 
            background-repeat: no-repeat;
            background-size: var(--bg-size-x) var(--bg-size-y);
            
            border-radius: 6px; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 0; 
            box-sizing: border-box;
            
            color: black;
            font-weight: bold;
            font-size: 20px;
            
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            
            position: absolute; 
            left: 50%;
            top: 50%;
            margin-left: -9vw;  
            margin-top: -13.5vw; 
            
            transform-style: preserve-3d;
            transition: transform 0.5s ease-out, opacity 0.5s;
            cursor: pointer;
            z-index: 10;
        }
        
        @media (min-width: 500px) {
            .card { margin-left: -45px; margin-top: -67.5px; }
        }

        .card-inner-text {
            width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
            padding: 5px; box-sizing: border-box; background: transparent; 
        }
        
        /* 小牌字體 */
        .card-corner { align-self: flex-start; font-size: 0.8em; line-height: 1; display: flex; flex-direction: column; align-items: center; }
        .card-center { font-size: 1.8em; }
        .card-corner.bottom { align-self: flex-end; transform: rotate(180deg); }
        .card.red { color: #d00; }
        .card.black { color: #000; }

        /* --- 牌背樣式 --- */
        .card.back {
            background-color: #8a0a0a; 
            background-image: var(--card-back-img) !important;
            background-size: cover !important;
            background-position: center !important;
            border: 4px solid white; 
            outline: 1px solid #999;
        }
        
        body:not(.has-custom-back) .card.back {
             background: 
                radial-gradient(circle at 50% 50%, transparent 20%, #8a0a0a 21%, #8a0a0a 30%, transparent 31%),
                repeating-linear-gradient(45deg, #700 0, #700 2px, #8a0a0a 2px, #8a0a0a 4px) !important;
             background-color: #8a0a0a;
        }

        .card.back * { display: none; } 

        /* --- 揭曉大牌層 --- */
        #reveal-container {
            display: none;
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            justify-content: center;
            align-items: center;
            z-index: 200;
            pointer-events: none; 
        }

        .big-card-wrapper {
            width: 70vw;
            height: 105vw; 
            max-width: 320px;
            max-height: 480px;
            perspective: 1500px;
            pointer-events: auto; 
        }

        .big-card-inner {
            position: relative;
            width: 100%; height: 100%;
            transition: transform 0.8s ease-in-out;
            transform-style: preserve-3d;
        }

        .big-card-front, .big-card-back {
            position: absolute;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .big-card-back {
            background-color: #8a0a0a;
            background-image: var(--card-back-img);
            background-size: cover;
            background-position: center;
            border: 6px solid white;
            display: flex; justify-content: center; align-items: center;
        }
        
        body:not(.has-custom-back) .big-card-back {
             background: 
                radial-gradient(circle at 50% 50%, transparent 20%, #8a0a0a 21%, #8a0a0a 30%, transparent 31%),
                repeating-linear-gradient(45deg, #700 0, #700 2px, #8a0a0a 2px, #8a0a0a 4px);
             background-color: #8a0a0a;
        }

        .big-card-front {
            background-color: white;
            background-image: var(--card-sprite);
            background-repeat: no-repeat;
            background-size: var(--bg-size-x) var(--bg-size-y);
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px;
            color: black;
            transform: rotateY(180deg);
        }
        
        /* 大牌顏色樣式 (修復點) */
        .big-card-front.red { color: #d00; }
        .big-card-front.black { color: #000; }

        /* 大牌字體樣式 (修復點：使用與小牌相同的 Class，但調整大小) */
        .big-card-front .card-corner { 
            font-size: 48px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            z-index: -1; 
            line-height: 1;
        }
        .big-card-front .card-center { 
            font-size: 120px; 
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            z-index: -1;
        }
        .big-card-front .card-corner.bottom { 
            transform: rotate(180deg); 
            align-self: flex-end; 
        }
        
        .big-card-wrapper.flipped .big-card-inner { transform: rotateY(180deg); }

        /* --- 底部控制區 --- */
        .controls {
            position: absolute;
            bottom: 60px;
            width: 100%;
            z-index: 100;
            display: flex;
            justify-content: center;
        }

        /* 主按鈕樣式 */
        #action-btn {
            padding: 16px 50px;
            font-size: 18px;
            font-weight: bold;
            letter-spacing: 2px;
            text-transform: uppercase;
            border: none;
            border-radius: 50px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3), 0 6px 6px rgba(0,0,0,0.2), inset 0 -2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            outline: none;
            position: relative;
            overflow: hidden;
        }

        #action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
        }

        #action-btn:active {
            transform: scale(0.95);
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
        }

        #action-btn::after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: 0.5s;
        }
        
        #action-btn:hover::after {
            left: 100%;
            transition: 0.7s ease-in-out;
        }

        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        
        #secret-hint {
            position: absolute; top: 2px; left: 50%; transform: translateX(-50%);
            height: 2px; width: 2px; background: #333; border-radius: 50%;
            opacity: 0.5; transition: background 0.3s;
        }
    </style>
</head>
<body>

    <div id="help-btn" onclick="toggleHelp()"></div>
    <div id="secret-hint"></div>

    <!-- 設定選單 -->
    <div id="help-modal">
        <h3>魔術設定</h3>
        
        <div class="mode-switch-group">
            <div class="mode-option" id="mode-touch" onclick="setMode('touch')">
                <span class="mode-title">觸控模式</span>
                <span class="mode-desc">點區間揭曉</span>
            </div>
            <div class="mode-option" id="mode-sensor" onclick="setMode('sensor')">
                <span class="mode-title">感應模式</span>
                <span class="mode-desc">傾斜+點擊</span>
            </div>
        </div>

        <div class="upload-section">
            <span class="upload-label">客製化牌背圖案 (留空則用預設)</span>
            <div class="file-input-wrapper">
                <button class="btn-upload">上傳牌背圖片</button>
                <input type="file" id="back-upload" accept="image/*" onchange="handleBackUpload(this)">
            </div>
            <div id="back-upload-status" style="font-size:12px; color:#888; margin-top:5px;">未使用自訂圖片</div>
        </div>

        <div class="settings-box" id="settings-container"></div>
        
        <div class="settings-btns">
            <button class="setting-btn btn-save" onclick="saveCustomCards()">儲存設定</button>
            <button class="setting-btn btn-reset" onclick="resetDefaultCards()">重置</button>
        </div>

        <h3>祕技圖解</h3>
        <p>點擊下方圖示可開啟/關閉輔助線：</p>
        <div style="display:flex; width:100%; height:40px; margin-bottom:15px; border:1px solid #444; cursor:pointer;" id="visual-zones"></div>

        <button class="close-help" onclick="toggleHelp()">回到魔術</button>
    </div>

    <!-- 遊戲主畫面 -->
    <div class="game-area">
        <div id="zone-overlay"></div>
        <div class="card-container" id="cards-row"></div>
        <div id="reveal-container"></div>
    </div>

    <div class="controls">
        <button id="action-btn">打亂順序</button>
    </div>

    <script>
        const defaultCards = [
            { suit: '♣', val: '4', color: 'black' },
            { suit: '♥', val: '5', color: 'red' },
            { suit: '♦', val: '6', color: 'red' },
            { suit: '♠', val: 'J', color: 'black' },
            { suit: '♥', val: 'Q', color: 'red' }
        ];

        let cardsData = JSON.parse(localStorage.getItem('magicCards')) || JSON.parse(JSON.stringify(defaultCards));
        let currentMode = localStorage.getItem('magicMode') || 'touch'; 

        // 狀態管理
        let currentStage = 0; 
        let activeCardIndex = 2; 
        let selectedCardIndex = 2; 
        
        const HINT_COLORS = ['#fff', '#f00', '#0f0', '#00f', '#ff0']; 

        const cardsRow = document.getElementById('cards-row');
        const actionBtn = document.getElementById('action-btn');
        const hint = document.getElementById('secret-hint');
        const revealContainer = document.getElementById('reveal-container');
        const helpModal = document.getElementById('help-modal');
        const zoneOverlay = document.getElementById('zone-overlay');

        function initApp() {
            loadCardBack(); 
            initCards();
            updateModeUI();
            initSettings();
            updateZoneVisuals();
            
            actionBtn.addEventListener('click', handleMainButton);
            
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        // --- 牌背處理 ---
        function handleBackUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgData = e.target.result;
                    try {
                        localStorage.setItem('magicCardBack', imgData);
                        applyCardBack(imgData);
                        document.getElementById('back-upload-status').innerText = "✅ 已套用";
                    } catch (err) {
                        alert("圖片太大，無法儲存");
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function loadCardBack() {
            const savedBack = localStorage.getItem('magicCardBack');
            if (savedBack) {
                applyCardBack(savedBack);
                document.getElementById('back-upload-status').innerText = "✅ 使用中";
            }
        }

        function applyCardBack(imgData) {
            document.documentElement.style.setProperty('--card-back-img', `url('${imgData}')`);
            document.body.classList.add('has-custom-back');
        }

        // 主按鈕邏輯
        function handleMainButton() {
            if (currentStage === 3) {
                resetTable();
            } else {
                performShuffle();
            }
        }

        function resetTable() {
            currentStage = 0;
            revealContainer.style.display = 'none';
            revealContainer.innerHTML = '';
            cardsRow.style.opacity = '1';
            cardsRow.style.pointerEvents = 'auto';
            
            const cards = document.querySelectorAll('.card');
            cards.forEach(c => {
                c.classList.remove('back');
                c.style.transition = 'transform 0.5s ease-out';
                c.style.transform = c.dataset.baseTransform; 
                c.style.zIndex = 10;
                c.style.opacity = 1;
                c.style.pointerEvents = 'auto';
            });
            
            actionBtn.innerText = "打亂順序";
            actionBtn.style.opacity = 1;
        }

        function performShuffle() {
            const cards = document.querySelectorAll('.card');
            
            cards.forEach(c => c.classList.add('back'));
            
            setTimeout(() => {
                cards.forEach(c => c.style.transform = `translateX(0)`);
            }, 300);

            let count = 0;
            let interval = setInterval(() => {
                count++;
                cards.forEach(c => {
                    c.style.zIndex = Math.floor(Math.random() * 10);
                    const rx = Math.random() * 20 - 10; 
                    const ry = Math.random() * 20 - 10; 
                    const rr = Math.random() * 10 - 5; 
                    c.style.transform = `translate(${rx}px, ${ry}px) rotate(${rr}deg)`;
                });

                if (count > 8) {
                    clearInterval(interval);
                    dealCardsBack();
                }
            }, 80);
        }

        function dealCardsBack() {
            const cards = document.querySelectorAll('.card');
            cards.forEach((c, index) => {
                c.style.zIndex = index + 10;
                c.style.transition = 'transform 0.5s ease-out';
                c.style.transform = c.dataset.baseTransform;
            });
            
            setTimeout(() => {
                currentStage = 1;
            }, 500);
        }

        function handleCardClick(index, e) {
            if (currentStage !== 1) return;
            if(e.type === 'touchstart') e.preventDefault(); 
            
            activeCardIndex = index;
            moveToCenter();
        }

        function moveToCenter() {
            if(navigator.vibrate) navigator.vibrate(20);
            
            currentStage = 2; 
            
            actionBtn.style.opacity = '0';
            actionBtn.style.pointerEvents = 'none'; 

            const cards = document.querySelectorAll('.card');

            // 計算放大比例 (適應螢幕寬度)
            const baseWidth = cards[0].offsetWidth;
            const viewportWidth = window.innerWidth;
            let targetWidth = viewportWidth * 0.7; 
            if (targetWidth > 320) targetWidth = 320; 
            const scaleFactor = (targetWidth / baseWidth);

            cards.forEach((card, index) => {
                if (index === activeCardIndex) {
                    card.style.zIndex = 100;
                    card.style.transition = 'all 0.8s cubic-bezier(0.19, 1, 0.22, 1)';
                    card.style.transform = `translateX(0) scale(${scaleFactor})`;
                } 
                else {
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '0';
                    card.style.pointerEvents = 'none';
                }
            });

            setTimeout(() => {
                window.addEventListener('click', handleStage2Click);
                window.addEventListener('touchend', handleStage2Click);
            }, 100); 
        }

        function handleStage2Click(e) {
            if (currentStage !== 2) return;
            if (e.target.closest('#help-btn') || e.target.closest('#help-modal')) return;
            finalReveal(e);
        }

        function finalReveal(e) {
            if(e && e.stopPropagation) e.stopPropagation();
            
            if (currentMode === 'touch') {
                let clientX = e.clientX;
                if (e.type === 'touchend' && e.changedTouches && e.changedTouches.length > 0) {
                    clientX = e.changedTouches[0].clientX;
                }
                const width = window.innerWidth;
                const zoneWidth = width / 5;
                const zoneIndex = Math.floor(clientX / zoneWidth);
                
                if (zoneIndex >= 0 && zoneIndex <= 4) {
                    selectedCardIndex = zoneIndex;
                } else {
                    selectedCardIndex = 2; 
                }
            } 

            window.removeEventListener('click', handleStage2Click);
            window.removeEventListener('touchend', handleStage2Click);

            currentStage = 3;
            if(navigator.vibrate) navigator.vibrate(50);
            
            const cardData = cardsData[selectedCardIndex];
            
            // Sprite 位置計算
            const SUIT_MAP = { '♠': 0, '♥': 1, '♣': 2, '♦': 3 };
            const VAL_MAP = { 'A': 0, '2': 1, '3': 2, '4': 3, '5': 4, '6': 5, '7': 6, '8': 7, '9': 8, '10': 9, 'J': 10, 'Q': 11, 'K': 12 };
            const row = SUIT_MAP[cardData.suit] !== undefined ? SUIT_MAP[cardData.suit] : 0;
            const col = VAL_MAP[cardData.val] !== undefined ? VAL_MAP[cardData.val] : 0;
            const x = (col / 12) * 100;
            const y = (row / 3) * 100;
            const bgPos = `calc(${x}% + var(--bg-off-x)) calc(${y}% + var(--bg-off-y))`;

            revealContainer.innerHTML = `
                <div class="big-card-wrapper" id="big-card-wrapper">
                    <div class="big-card-inner">
                        <div class="big-card-back"></div>
                        <div class="big-card-front ${cardData.color}" style="background-position: ${bgPos}">
                            <div class="card-inner-text">
                                <div class="card-corner"><span>${cardData.val}</span><span>${cardData.suit}</span></div>
                                <div class="card-center">${cardData.suit}</div>
                                <div class="card-corner bottom"><span>${cardData.val}</span><span>${cardData.suit}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            revealContainer.style.display = 'flex';
            cardsRow.style.opacity = '0'; 
            zoneOverlay.classList.remove('visible');

            setTimeout(() => {
                const wrapper = document.getElementById('big-card-wrapper');
                if(wrapper) wrapper.classList.add('flipped');
                
                setTimeout(() => {
                    actionBtn.innerText = "重新開始";
                    actionBtn.style.opacity = '1';
                    actionBtn.style.pointerEvents = 'auto';
                }, 800);
            }, 50); 
        }

        function handleOrientation(event) {
            if (currentStage !== 1 || currentMode !== 'sensor') return;
            const beta = event.beta; 
            if (beta === null) return;

            let idx = 2;
            if (beta < 20) idx = 0;      
            else if (beta < 35) idx = 1; 
            else if (beta < 55) idx = 2; 
            else if (beta < 75) idx = 3; 
            else idx = 4;                
            
            selectedCardIndex = idx; 
            hint.style.backgroundColor = HINT_COLORS[idx];
        }

        function initCards() {
            cardsRow.innerHTML = '';
            cardsData.forEach((card, index) => {
                let div = document.createElement('div');
                div.className = `card ${card.color}`;
                div.id = `card-${index}`;
                
                // Sprite position
                const SUIT_MAP = { '♠': 0, '♥': 1, '♣': 2, '♦': 3 };
                const VAL_MAP = { 'A': 0, '2': 1, '3': 2, '4': 3, '5': 4, '6': 5, '7': 6, '8': 7, '9': 8, '10': 9, 'J': 10, 'Q': 11, 'K': 12 };
                const row = SUIT_MAP[card.suit] !== undefined ? SUIT_MAP[card.suit] : 0;
                const col = VAL_MAP[card.val] !== undefined ? VAL_MAP[card.val] : 0;
                const x = (col / 12) * 100;
                const y = (row / 3) * 100;
                div.style.backgroundPosition = `calc(${x}% + var(--bg-off-x)) calc(${y}% + var(--bg-off-y))`;
                
                div.innerHTML = `
                    <div class="card-inner-text">
                        <div class="card-corner"><span>${card.val}</span><span>${card.suit}</span></div>
                        <div class="card-center">${card.suit}</div>
                        <div class="card-corner bottom"><span>${card.val}</span><span>${card.suit}</span></div>
                    </div>
                `;
                
                // 固定位置邏輯 (修正版)
                // 寬度 18vw, 間距 20vw => 總寬 = 20*4 = 80vw + 18vw = 98vw，剛好塞滿
                const offset = (index - 2) * 20; 
                const transform = `translateX(${offset}vw)`;
                div.style.transform = transform;
                div.dataset.baseTransform = transform;
                
                div.addEventListener('click', (e) => handleCardClick(index, e));
                div.addEventListener('touchstart', (e) => handleCardClick(index, e), {passive: false});

                cardsRow.appendChild(div);
            });
        }

        function toggleHelp() {
            if (helpModal.style.display === 'flex') {
                helpModal.style.display = 'none';
            } else {
                initSettings(); 
                helpModal.style.display = 'flex';
            }
        }

        function setMode(mode) {
            currentMode = mode;
            localStorage.setItem('magicMode', mode);
            updateModeUI();
            if (mode === 'sensor' && typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().catch(e => {});
            }
        }

        function updateModeUI() {
            document.getElementById('mode-touch').className = `mode-option ${currentMode === 'touch' ? 'active' : ''}`;
            document.getElementById('mode-sensor').className = `mode-option ${currentMode === 'sensor' ? 'active' : ''}`;
            hint.style.display = currentMode === 'sensor' ? 'block' : 'none';
        }

        document.getElementById('visual-zones').onclick = function() {
            const overlay = document.getElementById('zone-overlay');
            if(overlay.classList.contains('visible')) overlay.classList.remove('visible');
            else overlay.classList.add('visible');
        };

        function initSettings() {
            const container = document.getElementById('settings-container');
            container.innerHTML = '';
            const suits = ['♠', '♥', '♦', '♣'];
            const vals = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];

            cardsData.forEach((card, index) => {
                const row = document.createElement('div');
                row.className = 'card-setting-row';
                let html = `<span>卡片 ${index + 1}</span>`;
                html += `<select id="setting-suit-${index}">`;
                suits.forEach(s => {
                    const selected = (s === card.suit) ? 'selected' : '';
                    html += `<option value="${s}" ${selected}>${s}</option>`;
                });
                html += `</select>`;
                html += `<select id="setting-val-${index}">`;
                vals.forEach(v => {
                    const selected = (v === card.val) ? 'selected' : '';
                    html += `<option value="${v}" ${selected}>${v}</option>`;
                });
                html += `</select>`;
                row.innerHTML = html;
                container.appendChild(row);
            });
            updateZoneVisuals();
        }

        function updateZoneVisuals() {
            const visualContainer = document.getElementById('visual-zones');
            const overlayContainer = document.getElementById('zone-overlay');
            visualContainer.innerHTML = '';
            overlayContainer.innerHTML = '';
            const zoneNames = ['左', '中左', '中', '中右', '右'];
            const bgColors = ['rgba(255,255,255,0.1)', 'rgba(255,255,255,0.05)', 'rgba(255,255,255,0.1)', 'rgba(255,255,255,0.05)', 'rgba(255,255,255,0.1)'];

            cardsData.forEach((card, index) => {
                const colorClass = (card.suit === '♥' || card.suit === '♦') ? 'red-text' : '';
                const vDiv = document.createElement('div');
                vDiv.style.flex = '1';
                vDiv.style.display = 'flex';
                vDiv.style.flexDirection = 'column';
                vDiv.style.justifyContent = 'center';
                vDiv.style.alignItems = 'center';
                vDiv.style.background = bgColors[index];
                vDiv.style.fontSize = '12px';
                vDiv.innerHTML = `<span style="font-size:9px;color:#888;">${zoneNames[index]}</span><strong class="${colorClass}">${card.val}${card.suit}</strong>`;
                visualContainer.appendChild(vDiv);

                const oDiv = document.createElement('div');
                oDiv.className = 'zone-col';
                oDiv.innerHTML = `
                    <div class="zone-title">區間 ${index + 1}</div>
                    <div class="zone-card ${colorClass}">${card.val}${card.suit}</div>
                `;
                overlayContainer.appendChild(oDiv);
            });
        }

        function saveCustomCards() {
            const newCards = [];
            for(let i=0; i<5; i++) {
                const s = document.getElementById(`setting-suit-${i}`).value;
                const v = document.getElementById(`setting-val-${i}`).value;
                const c = (s === '♥' || s === '♦') ? 'red' : 'black';
                newCards.push({ suit: s, val: v, color: c });
            }
            cardsData = newCards;
            localStorage.setItem('magicCards', JSON.stringify(cardsData));
            initCards();
            updateZoneVisuals();
            toggleHelp();
        }

        function resetDefaultCards() {
            if(!confirm('恢復預設卡片？')) return;
            cardsData = JSON.parse(JSON.stringify(defaultCards));
            localStorage.setItem('magicCards', JSON.stringify(cardsData));
            initCards();
            initSettings(); 
            updateZoneVisuals();
        }

        initApp();

    </script>
</body>
</html>