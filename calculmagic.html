<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <meta name="format-detection" content="telephone=no">
    <title>Calculator</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            background-color: #000;
            color: white;
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background: #000;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .ease-ios { transition-timing-function: cubic-bezier(0.32, 0.72, 0, 1); }
        
        .btn-press { transition: filter 0.1s, transform 0.05s; }
        .btn-num-press:active { filter: brightness(1.6); }
        .btn-func-press:active { filter: brightness(0.7); }
        .btn-op-press:active { filter: brightness(0.8); opacity: 0.8; }

        .backdrop-blur-xl { 
            -webkit-backdrop-filter: blur(24px); 
            backdrop-filter: blur(24px); 
        }

        * { -webkit-tap-highlight-color: transparent; }

        .safe-pb {
            padding-bottom: env(safe-area-inset-bottom, 34px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const ClockIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
        );
        
        const CalculatorIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
                <path fillRule="evenodd" d="M18 2H6C3.79 2 2 3.79 2 6V18C2 20.21 3.79 22 6 22H18C20.21 22 22 20.21 22 18V6C22 3.79 20.21 2 18 2ZM6 4H18C19.1 4 20 4.9 20 6V18C20 19.1 19.1 20 18 20H6C4.9 20 4 19.1 4 18V6C4 4.9 4.9 4 6 4Z" clipRule="evenodd" opacity="0.3"/>
                <rect x="6" y="6" width="12" height="3" rx="0.5" fill="currentColor" />
                <rect x="6" y="11" width="3" height="3" rx="0.5" fill="currentColor" />
                <rect x="10.5" y="11" width="3" height="3" rx="0.5" fill="currentColor" />
                <rect x="15" y="11" width="3" height="3" rx="0.5" fill="currentColor" />
                <rect x="6" y="15.5" width="3" height="3" rx="0.5" fill="currentColor" />
                <rect x="10.5" y="15.5" width="3" height="3" rx="0.5" fill="currentColor" />
                <rect x="15" y="15.5" width="3" height="3" rx="0.5" fill="currentColor" />
            </svg>
        );

        const PlusMinusIcon = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M12 5v6m-3-3h6" />
                <path d="M9 17h6" />
            </svg>
        );

        const DeleteIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M22 5H9l-8 7 8 7h13a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2z"/>
                <line x1="18" y1="9" x2="12" y2="15"/>
                <line x1="12" y1="9" x2="18" y2="15"/>
            </svg>
        );

        const XIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );

        const MagicCalculator = () => {
            const [inputExpression, setInputExpression] = useState('0');
            const [lastExpression, setLastExpression] = useState('');
            const [isResultState, setIsResultState] = useState(false);
            const [activeOp, setActiveOp] = useState(null); 
            
            // Magic States
            const [isForceMode, setIsForceMode] = useState(false); 
            const [isGhostMode, setIsGhostMode] = useState(false); 
            
            const [customTarget, setCustomTarget] = useState(null); 
            const [magicRemainder, setMagicRemainder] = useState(''); 
            const [magicIndex, setMagicIndex] = useState(0); 
            
            const [debugMode, setDebugMode] = useState(false);

            const forceTimerRef = useRef(null);
            const isForceTriggeredRef = useRef(false);

            const triggerHaptic = () => {
                if (navigator.vibrate) navigator.vibrate(10);
            };

            const calculateTimeNumber = () => {
                const now = new Date();
                const month = String(now.getMonth() + 1);
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const min = String(now.getMinutes()).padStart(2, '0');
                return parseInt(`${month}${day}${hours}${min}`);
            };

            const formatDisplay = (expr) => {
                if (!expr) return '';
                let visualStr = expr
                .replace(/\*/g, 'Ã—') 
                .replace(/\//g, 'Ã·')
                .replace(/\+/g, '+')
                .replace(/\-/g, 'âˆ’');
                
                return visualStr.replace(/(\d+)(\.\d+)?/g, (match, p1, p2) => {
                    return Number(p1).toLocaleString('en-US') + (p2 || '');
                });
            };

            const safeCalculate = (expr) => {
                try {
                    const sanitized = expr.replace(/[^0-9+\-*/.]/g, '');
                    const result = new Function('return ' + sanitized)();
                    return parseFloat(Number(result).toPrecision(12)); 
                } catch (e) {
                    return 'Error';
                }
            };

            const calculateRemainder = (targetVal) => {
                let currentExpr = inputExpression;
                if (['+', '-', '*', '/'].includes(currentExpr.slice(-1))) {
                    currentExpr = currentExpr.slice(0, -1);
                }
                const currentVal = safeCalculate(currentExpr);
                if (currentVal === 'Error' || isNaN(currentVal)) {
                    return String(targetVal); 
                }
                let diff = targetVal - currentVal;
                // å¦‚æœå·®é¡ç‚ºè² ï¼Œå–çµ•å°å€¼è®“é¬¼å½±èƒ½æ‰“å‡ºä¾†ï¼Œä½†é€™æœƒå°è‡´ safeCalculate çµæœéŒ¯èª¤
                // è¡¨æ¼”è€…éœ€è‡ªè¡Œæ§åˆ¶ï¼ˆé€šå¸¸ç”¨åŠ æ³•ï¼‰
                if (diff < 0) return String(Math.abs(diff));
                return String(diff);
            };

            const getFontSizeClass = (str) => {
                const len = str.length;
                if (len > 9) return 'text-[2.8rem]';
                if (len > 8) return 'text-[3.2rem]';
                if (len > 7) return 'text-[3.8rem]';
                if (len > 6) return 'text-[4.5rem]';
                return 'text-[5.5rem]'; 
            };

            // Logic
            const handleNumPress = (num) => {
                triggerHaptic();
                setActiveOp(null);

                // --- é­”è¡“é‚è¼¯ï¼šä¸€éµ/äºŒéµé¡¯ç¤ºé¬¼å½±æ•¸å­— ---
                if (isForceMode || isGhostMode) {
                    if (magicRemainder.length > 0) {
                        if (magicIndex === 0) {
                            // ç¬¬ä¸€ä¸‹ï¼šé¡¯ç¤ºç¬¬ä¸€å€‹å­—
                            const char = magicRemainder[0];
                            if (isResultState || inputExpression === '0') {
                                setInputExpression(char);
                                setIsResultState(false);
                            } else {
                                setInputExpression(prev => prev + char);
                            }
                            setMagicIndex(1);
                        } else if (magicIndex === 1) {
                            // ç¬¬äºŒä¸‹ï¼šé¡¯ç¤ºå‰©ä¸‹çš„å…¨éƒ¨
                            const rest = magicRemainder.slice(1);
                            if (rest.length > 0) {
                                setInputExpression(prev => prev + rest);
                            }
                            setMagicIndex(2);
                        }
                    }
                    return; 
                }
                
                // --- æ­£å¸¸è¼¸å…¥ ---
                if (isResultState) {
                    handleNewInput(num, true);
                    return;
                }
                handleNewInput(num, false);
            };

            const handleNewInput = (num, reset) => {
                const val = String(num);
                if (reset) {
                    setLastExpression('');
                    setInputExpression(val === '.' ? '0.' : val);
                    setIsResultState(false);
                    return;
                }
                if (inputExpression === '0' && val !== '.') {
                    setInputExpression(val);
                } else {
                    if (val === '.') {
                        const parts = inputExpression.split(/[\+\-\*\/]/);
                        const currentNum = parts[parts.length - 1];
                        if (currentNum.includes('.')) return;
                    }
                    setInputExpression(prev => prev + val);
                }
            };

            const handleOperator = (op) => {
                triggerHaptic();
                setIsResultState(false);
                setLastExpression('');
                setActiveOp(op);
                
                const lastChar = inputExpression.slice(-1);
                const isLastOp = ['+', '-', '*', '/'].includes(lastChar);
                if (isLastOp) {
                    setInputExpression(prev => prev.slice(0, -1) + op);
                } else {
                    if (inputExpression === 'Error') {
                        setInputExpression('0');
                    } else {
                        setInputExpression(prev => prev + op);
                    }
                }
            };

            const handleEqual = () => {
                triggerHaptic();
                if (isResultState) return;
                setActiveOp(null);
                
                let finalResult;
                
                // --- çµæœé‚è¼¯ ---
                if (isGhostMode) {
                    // æ™‚é–“é è¨€ï¼šä½¿ç”¨çœŸå¯¦è¨ˆç®—çµæœ (ä¸å¼·åˆ¶)
                    // é€™æ¨£å¦‚æœè§€çœ¾æª¢æŸ¥ç®—å¼ï¼Œçµæœæ˜¯æ­£ç¢ºçš„
                    finalResult = safeCalculate(inputExpression);
                    resetMagic();
                } else if (isForceMode) {
                    // å¼·é¸æ¨¡å¼ï¼šå¦‚æœæœ‰è¨­å®šç›®æ¨™ï¼Œå‰‡å¼·åˆ¶é¡¯ç¤º
                    // é€™æ˜¯ç‚ºäº†ç¢ºä¿é è¨€çµ•å°å‘½ä¸­
                    if (customTarget !== null) {
                        finalResult = customTarget;
                    } else {
                        finalResult = safeCalculate(inputExpression);
                    }
                    resetMagic();
                } else {
                    // æ™®é€šæ¨¡å¼
                    finalResult = safeCalculate(inputExpression);
                }

                setLastExpression(formatDisplay(inputExpression) + ' =');
                setInputExpression(String(finalResult));
                setIsResultState(true);
            };

            const handleClear = () => {
                triggerHaptic();
                setActiveOp(null);
                if (inputExpression !== '0' || lastExpression !== '') {
                    setInputExpression('0');
                    setLastExpression('');
                    setIsResultState(false);
                    if (isForceMode || isGhostMode) setMagicIndex(0);
                }
            };

            const handleToggleSign = () => {
                triggerHaptic();
                if (!isResultState && inputExpression !== '0') {
                     if (!isNaN(inputExpression)) {
                         setInputExpression(String(parseFloat(inputExpression) * -1));
                     }
                }
            };
            
            const handlePercent = () => {
                triggerHaptic();
                if (!isNaN(inputExpression)) {
                     setInputExpression(String(parseFloat(inputExpression) / 100));
                }
            };

            const handleBackspace = () => {
                triggerHaptic();
                if (isResultState) {
                    setLastExpression('');
                    setInputExpression('0');
                    setIsResultState(false);
                    return;
                }
                if (inputExpression.length > 1) {
                    setInputExpression(prev => prev.slice(0, -1));
                } else {
                    setInputExpression('0');
                }
            };

            const resetMagic = () => {
                setIsForceMode(false);
                setIsGhostMode(false);
                setMagicRemainder('');
            };

            // --- è§¸ç™¼å™¨é‚è¼¯ ---

            // å·¦ä¸Šè§’ (æ™‚é˜)ï¼šçŸ­æŒ‰é–‹å•Ÿé¬¼å½±æ¨¡å¼ (æ™‚é–“é è¨€)
            const toggleGhostMode = () => {
                if (isGhostMode || isForceMode) {
                    resetMagic();
                    return;
                }
                
                const target = calculateTimeNumber();
                const remainder = calculateRemainder(target);
                
                setIsGhostMode(true);
                setMagicRemainder(remainder);
                setMagicIndex(0);
                setIsResultState(false);
                
                if (navigator.vibrate) navigator.vibrate([50, 50]); 
            };

            // å³ä¸Šè§’ (è¨ˆç®—æ©Ÿ)ï¼šçŸ­æŒ‰å•Ÿå‹•ï¼Œé•·æŒ‰è¨­å®š
            const handleForceLongPress = () => {
                const currentScreenVal = safeCalculate(inputExpression);
                if (currentScreenVal !== 'Error' && !isNaN(currentScreenVal)) {
                     setCustomTarget(currentScreenVal);
                     setInputExpression('0'); 
                     setLastExpression('');
                     if (navigator.vibrate) navigator.vibrate([30, 50]); 
                }
            };
            
            const handleForceShortPress = () => {
                 if (isForceMode) {
                    resetMagic();
                    return;
                }
                if (isGhostMode) resetMagic();

                if (customTarget !== null) {
                    const remainder = calculateRemainder(customTarget);
                    setMagicRemainder(remainder);
                }
                setMagicIndex(0);
                setIsForceMode(true);
                setIsResultState(false);
                if (navigator.vibrate) navigator.vibrate(10);
            };

            const handleForceTouchStart = () => {
                isForceTriggeredRef.current = false;
                forceTimerRef.current = setTimeout(() => {
                    handleForceLongPress();
                    isForceTriggeredRef.current = true;
                }, 600); 
            };

            const handleForceTouchEnd = (e) => {
                if (forceTimerRef.current) clearTimeout(forceTimerRef.current);
                
                if (isForceTriggeredRef.current) {
                    e.preventDefault(); 
                } else {
                    handleForceShortPress();
                }
            };

            const Button = ({ text, icon, type, onClick, opValue, wide }) => {
                const bgColors = {
                    func: 'bg-[#A5A5A5] text-black', 
                    num: 'bg-[#333333] text-white',   
                    orange: 'bg-[#FF9F0A] text-white',
                };
                
                let btnColor = bgColors.num;
                let fontSize = 'text-[2.6rem]'; 
                let pressEffect = 'btn-num-press';

                if (type === 'func') {
                    btnColor = bgColors.func;
                    fontSize = 'text-[2.2rem]';
                    pressEffect = 'btn-func-press';
                }
                if (type === 'op') {
                    btnColor = bgColors.orange;
                    fontSize = 'text-[3rem]'; 
                    pressEffect = 'btn-op-press';
                    if (activeOp && activeOp === opValue) {
                        btnColor = 'bg-white text-[#FF9F0A]';
                        pressEffect = '';
                    }
                }

                let content = icon ? icon : text;
                // è¦–è¦ºæš—è™Ÿ
                if (text === '.') {
                    content = (
                        <span 
                            className={`transition-transform duration-500 ease-in-out block ${(isForceMode || isGhostMode) ? 'scale-[1.8] font-medium' : 'scale-100'}`}
                            style={{ transformOrigin: '50% 65%' }}
                        >
                            .
                        </span>
                    );
                }

                return (
                <button 
                    onClick={onClick} 
                    className={`
                        relative
                        ${wide ? 'col-span-2 w-auto pl-[34px] text-left items-center justify-start rounded-[44px]' : 'w-full aspect-square justify-center rounded-full'}
                        ${btnColor}
                        ${fontSize} font-light leading-none flex items-center select-none btn-press ${pressEffect} transition-all duration-100
                    `}
                    style={{ WebkitTapHighlightColor: 'transparent' }}
                >
                    {content}
                </button>
                );
            };

            const clearBtnText = (inputExpression === '0' && lastExpression === '') ? 'AC' : 'C';

            return (
                <div className="flex justify-center items-center h-[100dvh] w-full font-sans overflow-hidden relative bg-black">
                    
                    <div className="relative w-full h-full sm:w-[390px] sm:h-[844px] sm:bg-black sm:rounded-[48px] sm:border-[10px] sm:border-[#1c1c1e] sm:shadow-2xl flex flex-col overflow-hidden z-10 transition-all duration-300">
                        
                        {/* é ‚éƒ¨åœ–ç¤ºå€ */}
                        <div className="flex justify-between px-6 pt-12 z-40 relative">
                             {/* å·¦ä¸Šè§’ï¼šçŸ­æŒ‰é¬¼å½±(æ™‚é–“) */}
                             <div 
                                className="w-10 h-10 rounded-full flex items-center justify-center border border-white/30 text-white hover:bg-white/10 transition-colors cursor-pointer select-none"
                                onClick={toggleGhostMode}
                             >
                                <ClockIcon className="w-6 h-6" />
                             </div>
                             
                             {/* éš±è—å¼ Debug æŒ‰éˆ• */}
                             <div 
                                className="absolute top-12 left-1/2 transform -translate-x-1/2 w-20 h-10 z-50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity"
                                onClick={() => setDebugMode(!debugMode)}
                             >
                             </div>
                             
                             {/* å³ä¸Šè§’ï¼šçŸ­æŒ‰å•Ÿå‹•ï¼Œé•·æŒ‰è¨­å®šæ•¸å­— */}
                             <div 
                                className="w-10 h-10 rounded-full flex items-center justify-center border border-white/30 text-white cursor-pointer active:opacity-50 transition-opacity relative select-none"
                                onMouseDown={handleForceTouchStart}
                                onMouseUp={handleForceTouchEnd}
                                onTouchStart={handleForceTouchStart}
                                onTouchEnd={handleForceTouchEnd}
                                onMouseLeave={() => {
                                    if(forceTimerRef.current) clearTimeout(forceTimerRef.current);
                                }}
                                onContextMenu={(e) => e.preventDefault()}
                             >
                                <CalculatorIcon className="w-6 h-6" />
                             </div>
                        </div>

                        {/* è¢å¹•é¡¯ç¤ºå€ */}
                        <div className="flex-1 flex flex-col justify-end items-end px-9 pb-6 gap-0 relative z-10 pointer-events-none">
                            <div className={`text-[#8e8e93] text-[1.5rem] font-light tracking-wide transition-all duration-300 min-h-[30px] transform origin-right ${lastExpression ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-2'}`}>
                                {lastExpression}
                            </div>
                            <div className={`text-white font-light leading-none transition-all duration-200 tracking-tight ${getFontSizeClass(formatDisplay(inputExpression))}`}>
                                {formatDisplay(inputExpression)}
                            </div>
                        </div>

                        {/* éµç›¤å€åŸŸ */}
                        <div className="px-4 pb-[env(safe-area-inset-bottom,34px)] mb-2">
                            <div className="grid grid-cols-4 gap-[14px]">
                                {/* Row 1 */}
                                <Button icon={<DeleteIcon className="w-8 h-8" />} type="func" onClick={handleBackspace} />
                                <Button text={clearBtnText} type="func" onClick={handleClear} />
                                <Button text="%" type="func" onClick={handlePercent} />
                                <Button text="Ã·" type="op" opValue="/" onClick={() => handleOperator('/')} />

                                {/* Row 2 */}
                                <Button text="7" type="num" onClick={() => handleNumPress(7)} />
                                <Button text="8" type="num" onClick={() => handleNumPress(8)} />
                                <Button text="9" type="num" onClick={() => handleNumPress(9)} />
                                <Button text="Ã—" type="op" opValue="*" onClick={() => handleOperator('*')} />

                                {/* Row 3 */}
                                <Button text="4" type="num" onClick={() => handleNumPress(4)} />
                                <Button text="5" type="num" onClick={() => handleNumPress(5)} />
                                <Button text="6" type="num" onClick={() => handleNumPress(6)} />
                                <Button text="âˆ’" type="op" opValue="-" onClick={() => handleOperator('-')} />

                                {/* Row 4 */}
                                <Button text="1" type="num" onClick={() => handleNumPress(1)} />
                                <Button text="2" type="num" onClick={() => handleNumPress(2)} />
                                <Button text="3" type="num" onClick={() => handleNumPress(3)} />
                                <Button text="+" type="op" opValue="+" onClick={() => handleOperator('+')} />

                                {/* Row 5 */}
                                <Button icon={<PlusMinusIcon className="w-8 h-8 text-white" />} type="num" onClick={handleToggleSign} />
                                <Button text="0" type="num" onClick={() => handleNumPress(0)} />
                                <Button text="." type="num" onClick={() => handleNewInput('.', false)} />
                                <Button text="=" type="op" onClick={handleEqual} />
                            </div>
                        </div>

                        {/* Debug é¢æ¿ */}
                        {debugMode && (
                            <div className="absolute top-20 left-6 bg-white/90 backdrop-blur-md text-black p-4 rounded-xl text-xs font-mono border w-48 shadow-2xl z-50 pointer-events-none">
                                <div className="font-bold border-b pb-2 mb-2 flex justify-between">
                                    <span>Magic Status</span>
                                    <span>
                                        {isForceMode ? <span className="text-green-600">FORCE ON</span> : ""}
                                        {isGhostMode ? <span className="text-purple-600"> GHOST ON</span> : ""}
                                        {!isForceMode && !isGhostMode ? <span className="text-red-600">OFF</span> : ""}
                                    </span>
                                </div>
                                <div>Time: {calculateTimeNumber()}</div>
                                <div>Saved Target: {customTarget || "None"}</div>
                                <div>Remainder: {magicRemainder}</div>
                                
                                <div className="mt-3 pt-2 border-t border-gray-300 space-y-1 text-[10px] text-gray-600">
                                    <p className="font-bold text-gray-800">æ“ä½œèªªæ˜:</p>
                                    <p>â° å·¦ä¸Š (æ™‚é˜):</p>
                                    <p>â€¢ çŸ­æŒ‰: æ™‚é–“é è¨€ (ä¸å¼·åˆ¶)</p>
                                    <p>ğŸ§® å³ä¸Š (è¨ˆç®—æ©Ÿ):</p>
                                    <p>â€¢ é•·æŒ‰: è¨­å®šç›®æ¨™</p>
                                    <p>â€¢ çŸ­æŒ‰: å¼·é¸é è¨€ (å¼·åˆ¶)</p>
                                    <p>ğŸ’¡ é¬¼å½±è¼¸å…¥: ç¬¬1ä¸‹å‡ºä¸€å­—ï¼Œç¬¬2ä¸‹å…¨å‡º</p>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MagicCalculator />);
    </script>
</body>
</html>


